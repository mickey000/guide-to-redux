<!DOCTYPE html>
<html>
<head>
    <title>Guide to Redux</title>
    <meta charset="UTF-8" />
</head>
<body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@16.3.1/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16.3.1/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/prop-types@15.6.1/prop-types.js"></script>
    <script src="https://unpkg.com/redux@4.0.0/dist/redux.js"></script>
    <script src="https://unpkg.com/react-redux@5.0.7/dist/react-redux.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.26.0/babel.js"></script>

    <script src="./reducers.js"></script>

    <script type="text/babel">

        const { createStore } = Redux;
        const { Provider, connect } = ReactRedux;

        // Action Creators

        let nextTodoId = 0;
        const addTodo = text => ({
            type: 'ADD_TODO',
            id: nextTodoId++,
            text
        });

        const toggleTodo = id => ({
            type: 'TOGGLE_TODO',
            id
        });

        const setVisibilityFilter = filter => ({
            type: 'SET_VISIBILITY_FILTER',
            filter
        });

        // AddTodo (container)
        let AddTodo = ({ dispatch }) => {
            let input;

            return (
                <div>
                    <input ref={node => { input = node; }} />
                    <button onClick={() => {
                        dispatch(addTodo(input.value));
                        input.value = '';
                    }}>
                        Add Todo
                    </button>
                </div>
            );
        };
        // null for mapStateToProps means that it's no need to subscribe for store updated
        // null for mapDispatchToProps means that it's enougth to pass dispatch itself as a property
        AddTodo = connect()(AddTodo);

        // Todo (presentation)
        class Todo extends React.Component {
            render() {
                const { text, completed, onClick} = this.props;

                return (
                <li
                    onClick={onClick}
                    style={{ textDecoration: completed
                        ? 'line-through'
                        : 'none'
                    }}
                >
                    {text}
                </li>
                );
            }
        }

        // TodoList (presentation)
        class TodoList extends React.Component {
            render() {
                const { todos, onTodoClick} = this.props;

                return (
                    <ul>
                        {todos.map(todo =>
                            <Todo
                                key={todo.id}
                                {...todo}
                                onClick={() => onTodoClick(todo.id)}
                            />
                        )}
                    </ul>
                );
            }
        }

        const getVisibleTodos = (todos = [], filter) => {
            switch (filter) {
                case 'SHOW_ALL':
                    return todos;
                case 'SHOW_COMPLETED':
                    return todos.filter(t => t.completed);
                case 'SHOW_ACTIVE':
                    return todos.filter(t => !t.completed);
                default:
                    return todos;
            }
        }
        
        // VisibleTodoList (container) exactly as in 02-... folder, but now generated by connect function
        const mapStateToTodoListProps = state => ({
            todos: getVisibleTodos(state.todos, state.visibilityFilter)
        });
        const mapDispatchToTodoListProps = dispatch => ({
            onTodoClick: id => dispatch(toggleTodo(id))
        });
        const VisibleTodoList = connect(
            mapStateToTodoListProps,
            mapDispatchToTodoListProps
        )(TodoList);

        // Link (presentation)
        class Link extends React.Component {
            render () {
                const { active, children, onClick } = this.props;

                if (active) {
                    return <span>{children}</span>;
                }

                return (
                    <a href='#'
                        onClick={e => {
                            e.preventDefault();
                            onClick();
                        }}
                    >
                        {children}
                    </a>
                );
            }
        }

        // FilterLink (container)
        const mapStateToLinkProps = (state, ownProps) => ({
            active: ownProps.filter === state.visibilityFilter
        });
        const mapDispatchToLinkProps = (dispatch, ownProps) => ({
            onClick: () => dispatch(setVisibilityFilter(ownProps.filter))
        });
        const FilterLink = connect(
            mapStateToLinkProps,
            mapDispatchToLinkProps
        )(Link);

        // Footer (presentation)
        class Footer extends React.Component {
            render () {
                return (
                    <p>
                        Show: {' '}
                        <FilterLink filter='SHOW_ALL'>
                            All
                        </FilterLink>
                        {', '}
                        <FilterLink filter='SHOW_ACTIVE'>
                            Active
                        </FilterLink>
                        {', '}
                        <FilterLink filter='SHOW_COMPLETED'>
                            Completed
                        </FilterLink>
                    </p>
                );
            }
        }

        // FINAL COMPONENT
        const TodoApp = () => (
            <div>
                <AddTodo />
                <VisibleTodoList />
                <Footer />
            </div>
        );

        ReactDOM.render(
            <Provider store={createStore(todoApp)}>
                <TodoApp />
            </Provider>,
            document.getElementById('root')
        );
    </script>
</body>
</html>